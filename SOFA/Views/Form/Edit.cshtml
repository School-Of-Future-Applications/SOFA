@using SOFA.Models.ViewModels.FormViewModels
@model SOFA.Models.ViewModels.FormViewModels.FormViewModel

@{
    ViewBag.Title = "Edit Form";
}

    <script>
        $(document).ready(function () {
            var $dialog = $("#addSectionDialog").dialog({
                autoOpen: false,
                width: 600,
                modal: true,
                resizeable: true,
                title: "Add Section",
                buttons: {
                    "Add to form": function () {
                        var SectionId = $("#SelectedSectionId").val();
                        var formid = $("#Id").val();
                        $.post(
                            "AddSection",
                            {
                                SectionId: SectionId,
                                FormId: formid
                            },
                            function (data) {
                                if (data.Success === "True") {
                                    $.get(
                                        "FormSection",
                                        {
                                            FormId: formid,
                                            SectionId: SectionId
                                        },
                                        function (data) {
                                            location.reload();
                                        }
                                    );
                                } else {
                                    console.log(data.Message);
                                }

                            }
                        );
                        $dialog.dialog("close");
                    },
                    Cancel: function () {
                        $dialog.dialog("close");
                    }
                }
            });

            $(".addSectionLink").on("click", function (event) {
                event.preventDefault();
                $dialog.load(this.href, function () {
                    $dialog.dialog('open');
                });
            });

            var $removeDialog = $("#removeSectionDialog").dialog({
                autoOpen: false,
                width: 350,
                modal: true,
                title: "Remove Section",
                buttons: {
                    "Remove": function () {
                        var $accLength = $accordion.children("div").size();
                        var $activeIndex = $accordion.accordion("option", "active");
                        if ($accLength == 1 && $activeIndex == 1) {
                            $activeIndex = 0;
                        }
                        var $activeDiv = $(".accordion-div").eq($activeIndex);
                        var $sectid = $activeDiv.find(".sectionId").val();

                        var $formid = $("#Id").val();
                        console.log($sectid);
                        $.post(
                            "RemoveSection",
                            {
                                FormId: $formid,
                                SectionId: $sectid
                            },
                            function (data) {
                                location.reload();

                            }
                        );
                        $removeDialog.dialog("close");

                    },
                    Cancel: function () {
                        $removeDialog.dialog("close");
                    }
                }
            });

            $(document).on("click", ".removeSectionLink", function (event) {
                event.preventDefault();
                $removeDialog.dialog('open');
            });

            var prev_sect_update = new Array();
            var $accordion = $("#accordion").accordion(
                {
                    header: "> div > h3",
                    heightStyle: "content"
                }).
                sortable({
                    axis: "y",
                    handle: "h3",
                    stop: function (event, ui) {
                        // IE doesn't register the blur when sorting
                        // so trigger focusout handlers to remove .ui-state-focus
                        ui.item.children("h3").triggerHandler("focusout");
                        var sections = $(".sectionId").toArray();
                        var $section_ids = new Array();
                        $.each(sections, function (i) {
                            $section_ids.push($(this).val());
                        });
                        // Refresh accordion to handle new order
                        $accordion.accordion("refresh");
                        //check if needs to be updated
                        var equal = true;
                        $.each($section_ids, function (i) {
                            if (!(this == prev_sect_update[i])) {
                                equal = false;
                                return false;
                            }
                        });
                        if (!equal) {
                            var $formID = $("#Id").val();
                            $.ajax({
                                type: "POST",
                                url: "UpdateSectionOrder",
                                dataType: "json",
                                traditional: true,
                                data: {
                                    FormID: $formID,
                                    SectionIDs: $section_ids
                                },
                                success: function (data, status, jqXHR) {
                                    console.log(data);
                                }
                            });
                        }
                        prev_sect_update = $section_ids;


                    }
                })


        });

    </script>
    <link href="~/Content/FormEdit.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Content/bootstrap-datetimepicker.min.css" />

    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/bootstrap-datetimepicker.min.js"></script>



<h2 class="r">Edit Form</h2>

@using (Html.BeginForm()) 
{
    @Html.AntiForgeryToken()
        
    <div class="form-horizontal">
        <h4>@Html.DisplayFor(m => m.FormName)</h4>
        <hr />
        @Html.ActionLink("Add Section", "IndexPartial", "Section", new { }, new { @class = "addSectionLink pull-right" })


        @Html.ValidationSummary(true)

        <div class="form-group">
            @Html.HiddenFor(m => m.Id)
        </div>

        

    </div>
    <div class="alert-danger"></div>
    <div id="accordion" >
        @if (Model.FormSections != null)
        { 
            @Html.DisplayFor(m => m.FormSections)
        }
        
    </div>
}

<div id="addSectionDialog">
    @Html.Action("IndexPartial", "Section")
</div>
<div id="removeSectionDialog">
    <p><span class="glyphicon glyphicon-warning-sign" > </span> Are you sure you want to remove this section from the form?</p>
</div>

<div>
    @Html.ActionLink("Back to List", "Index")
</div>
